{"ast":null,"code":"var _jsxFileName = \"/Users/minh/Desktop/TestSite/wc-prototype/src/pages/components/MarketTest.js\",\n    _s = $RefreshSig$();\n\nimport React, { useEffect, useState } from \"react\";\nimport * as sdk from \"@onflow/sdk\";\nimport TokenDataMarketTest from \"./TokenDataMarketTest\"; // Mainnet Access Node\n\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\nconst node = \"https://access-testnet.onflow.org\";\nconst EVENT_MOMENT_LISTED = \"A.1e9bb4b5d4200765.Marketplace.ForSale\"; // since last block returned is not sealed\n// we will go back a bit back in time\n\nvar SHIFT = 240;\nlet isSealed = false;\n\nfunction union(setA, setB) {\n  var _union = new Set(setA);\n\n  for (var elem of setB) {\n    _union.add(elem);\n  }\n\n  return _union;\n}\n\nexport default function MarketTest() {\n  _s();\n\n  const [lastBlock, setLastBlock] = useState(0);\n  const [eventIDs, setEventIdS] = useState(new Set());\n  const [eventsDictionary, setEventsDictionary] = useState({});\n\n  const fetchEvents = async height => {\n    console.log(\"Fetching Block\");\n\n    if (height == 0) {\n      const latestBlock = await sdk.send(await sdk.build([sdk.getBlock(isSealed)]), {\n        node\n      }); //console.log(latestBlock);\n\n      height = latestBlock.block.height;\n    }\n\n    console.log(height);\n    console.log(Object.keys(eventsDictionary).length);\n    let end = height;\n    let start = height - SHIFT; // fetch events\n\n    const response = await sdk.send(await sdk.build([sdk.getEventsAtBlockHeightRange(EVENT_MOMENT_LISTED, start, end)]), {\n      node\n    });\n    const {\n      events\n    } = response;\n\n    if (events.length > 0) {\n      const newSet = new Set(events.map(event => {\n        const id = event.payload.value.fields[0].value.value;\n        eventsDictionary[id] = event;\n        return id;\n      }));\n      const newEvents = union(eventIDs, newSet);\n      setEventsDictionary(eventsDictionary);\n      setEventIdS(newEvents);\n    } // update last processed block\n\n\n    setLastBlock(start);\n  };\n\n  useEffect(() => {\n    while (Object.keys(eventsDictionary).length == 0) {\n      fetchEvents(lastBlock);\n    }\n  }, []);\n  const events = Array.from(eventIDs);\n  return /*#__PURE__*/_jsxDEV(\"div\", {\n    className: \"Marketplace\",\n    children: [console.log(\"Memory Test\"), /*#__PURE__*/_jsxDEV(\"p\", {\n      children: [\"Latest processed block: \", /*#__PURE__*/_jsxDEV(\"b\", {\n        children: [\"#\", lastBlock]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 82,\n        columnNumber: 33\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 81,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"p\", {\n      children: [\"Events found: \", /*#__PURE__*/_jsxDEV(\"b\", {\n        children: events.length\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 85,\n        columnNumber: 23\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 84,\n      columnNumber: 7\n    }, this), /*#__PURE__*/_jsxDEV(\"table\", {\n      className: \"styled-table\",\n      children: [/*#__PURE__*/_jsxDEV(\"thead\", {\n        children: /*#__PURE__*/_jsxDEV(\"tr\", {\n          children: [/*#__PURE__*/_jsxDEV(\"th\", {\n            align: \"left\",\n            children: \"NFT ID\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 90,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"th\", {\n            align: \"left\",\n            children: \"Seller\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 91,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"th\", {\n            align: \"left\",\n            children: \"Price\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 92,\n            columnNumber: 13\n          }, this), /*#__PURE__*/_jsxDEV(\"th\", {\n            align: \"left\",\n            children: \"Metadata\"\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 93,\n            columnNumber: 13\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 89,\n          columnNumber: 11\n        }, this)\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 88,\n        columnNumber: 9\n      }, this), /*#__PURE__*/_jsxDEV(\"tbody\", {\n        children: events.map(eventId => {\n          const event = eventsDictionary[eventId];\n          const payload = event.payload.value.fields;\n          const [id, price, seller] = payload;\n          const nftId = id.value.value;\n          const nftPrice = price.value.value;\n          const nftSeller = seller.value.value.value;\n\n          const nftMetadata = /*#__PURE__*/_jsxDEV(TokenDataMarketTest, {\n            account: nftSeller,\n            nftID: nftId\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 104,\n            columnNumber: 33\n          }, this);\n\n          return /*#__PURE__*/_jsxDEV(\"tr\", {\n            children: [/*#__PURE__*/_jsxDEV(\"td\", {\n              align: \"left\",\n              children: [\"#\", nftId]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 107,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n              align: \"left\",\n              children: [\"#\", nftSeller]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 108,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n              align: \"left\",\n              children: [\"#\", nftPrice]\n            }, void 0, true, {\n              fileName: _jsxFileName,\n              lineNumber: 109,\n              columnNumber: 17\n            }, this), /*#__PURE__*/_jsxDEV(\"td\", {\n              align: \"left\",\n              children: nftMetadata\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 110,\n              columnNumber: 17\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 106,\n            columnNumber: 15\n          }, this);\n        })\n      }, void 0, false, {\n        fileName: _jsxFileName,\n        lineNumber: 96,\n        columnNumber: 9\n      }, this)]\n    }, void 0, true, {\n      fileName: _jsxFileName,\n      lineNumber: 87,\n      columnNumber: 7\n    }, this)]\n  }, void 0, true, {\n    fileName: _jsxFileName,\n    lineNumber: 79,\n    columnNumber: 5\n  }, this);\n}\n\n_s(MarketTest, \"Fc8Re4wTqNoH+abffBDvr6XAv6I=\");\n\n_c = MarketTest;\n\nvar _c;\n\n$RefreshReg$(_c, \"MarketTest\");","map":{"version":3,"sources":["/Users/minh/Desktop/TestSite/wc-prototype/src/pages/components/MarketTest.js"],"names":["React","useEffect","useState","sdk","TokenDataMarketTest","node","EVENT_MOMENT_LISTED","SHIFT","isSealed","union","setA","setB","_union","Set","elem","add","MarketTest","lastBlock","setLastBlock","eventIDs","setEventIdS","eventsDictionary","setEventsDictionary","fetchEvents","height","console","log","latestBlock","send","build","getBlock","block","Object","keys","length","end","start","response","getEventsAtBlockHeightRange","events","newSet","map","event","id","payload","value","fields","newEvents","Array","from","eventId","price","seller","nftId","nftPrice","nftSeller","nftMetadata"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from \"react\";\nimport * as sdk from \"@onflow/sdk\";\nimport TokenDataMarketTest from \"./TokenDataMarketTest\";\n\n// Mainnet Access Node\nconst node = \"https://access-testnet.onflow.org\";\nconst EVENT_MOMENT_LISTED = \"A.1e9bb4b5d4200765.Marketplace.ForSale\";\n\n// since last block returned is not sealed\n// we will go back a bit back in time\nvar SHIFT = 240;\nlet isSealed = false\n\nfunction union(setA, setB) {\n  var _union = new Set(setA);\n  for (var elem of setB) {\n    _union.add(elem);\n  }\n  return _union;\n}\n\nexport default function MarketTest() {\n  const [lastBlock, setLastBlock] = useState(0);\n  const [eventIDs, setEventIdS] = useState(new Set());\n  const [eventsDictionary, setEventsDictionary] = useState({});\n\n  const fetchEvents = async (height) => {\n    console.log(\"Fetching Block\");\n    if (height == 0) {\n    const latestBlock = await sdk.send(\n      await sdk.build([sdk.getBlock(isSealed)]),\n      {\n        node\n      }\n    );\n    //console.log(latestBlock);\n    height = latestBlock.block.height;\n    }\n    console.log(height);\n    console.log(Object.keys(eventsDictionary).length)\n    let end = height;\n    let start = height-SHIFT;\n\n    // fetch events\n    const response = await sdk.send(\n      await sdk.build([sdk.getEventsAtBlockHeightRange(EVENT_MOMENT_LISTED, start, end)]),\n      { node }\n    );\n\n    const { events } = response;\n\n    if (events.length > 0) {\n      const newSet = new Set(\n        events.map((event) => {\n          const id = event.payload.value.fields[0].value.value;\n          eventsDictionary[id] = event;\n          return id;\n        })\n      );\n      const newEvents = union(eventIDs, newSet);\n      setEventsDictionary(eventsDictionary);\n      setEventIdS(newEvents);\n    }\n\n    // update last processed block\n    setLastBlock(start);\n  };\n\n  useEffect(() => {\n    while(Object.keys(eventsDictionary).length == 0){\n      fetchEvents(lastBlock);\n    }\n  },[]);\n\n  const events = Array.from(eventIDs);\n\n  return (\n    \n    <div className=\"Marketplace\">\n      {console.log(\"Memory Test\")}\n      <p>\n        Latest processed block: <b>#{lastBlock}</b>\n      </p>\n      <p>\n        Events found: <b>{events.length}</b>\n      </p>\n      <table className=\"styled-table\">\n        <thead>\n          <tr>\n            <th align=\"left\">NFT ID</th>\n            <th align=\"left\">Seller</th>\n            <th align=\"left\">Price</th>\n            <th align=\"left\">Metadata</th>\n          </tr>\n        </thead>\n        <tbody>\n          {events.map((eventId) => {\n            const event = eventsDictionary[eventId];\n            const payload = event.payload.value.fields;\n            const [id, price, seller] = payload;\n            const nftId = id.value.value;\n            const nftPrice = price.value.value;\n            const nftSeller = seller.value.value.value;\n            const nftMetadata = <TokenDataMarketTest account={nftSeller} nftID={nftId}></TokenDataMarketTest>\n            return (\n              <tr>\n                <td align=\"left\">#{nftId}</td>\n                <td align=\"left\">#{nftSeller}</td>\n                <td align=\"left\">#{nftPrice}</td>\n                <td align=\"left\">{nftMetadata}</td>\n              </tr>\n            );\n          })}\n        </tbody>\n      </table>\n    </div>\n  );\n}\n"]},"metadata":{},"sourceType":"module"}